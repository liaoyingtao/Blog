原文：[Web Caching Explained by Buying Milk at the Supermarket
](https://dev.to/kbk0125/web-caching-explained-by-buying-milk-at-the-supermarket-9k4)

## 通过在超市买牛奶解释缓存机制(译)
**如果你在曾经在超市买过牛奶，那么你就可以理解服务器端和浏览器端的缓存机制了。**

如果你是一个狂热的网络使用者(你很可能是)，那么你已经很多次享受到缓存所带来的好处了。但是，你可能并不知道它其中的奥妙，以及它是如何或什么时候运行的。

从开发者角度来看，缓存使得构建高性能 web 应用和 web 服务器更加容易。开发人员可以利用缓存协议，从而达到生活美满，幸福安康。而不需要不断地去优化被成千上万个请求淹没的服务器。

经过在以前的项目中使用缓存，我意识到相比于一些烂大街的术语，有一种更好的方法去解释它。我意识到它和牛奶从农场，再到你的冰箱的这个方式非常相似，所以我认为这会是一种更好的解释方式。

为了读懂这篇指南，你需要知道一些 [web 服务器的基础知识](https://blog.codeanalogies.com/2018/04/26/web-servers-explained-by-running-a-microbrewery/)。让我们开始吧！

### 互联网没有缓存将会是什么样子
在进入主题之前，让我们想想如果没有缓存，互联网将会是什么样子。想象一哈，你生活中70世纪或80世纪的农村。你拥有一个农场，并且你的农场没有冰箱可以用。你的农场里有不少牛，但是它们的奶几乎没有任何价值，因为牛奶很快就会变质。

好了，现在你想把牛奶卖给你们村庄的人，并且需要在限定的时间内喝掉牛奶(容易变质)。让我们假设你的每头牛每天产出1加仑的牛奶。但是如果太多人来找你买牛奶，你就需要先送一部分人回家，让他们明天再来。

![01](./images/01_01.png)

同时，由于你分身乏力，自然也不可以通过买更多的奶牛来增加产出(农场原因)。只有你们村的村民才可以买你的牛奶(地理原因)。这些都是明确的限制。

![02](./images/01_02.png)

没有缓存，你将受限于服务器的计算能力。

而缓存用来加载静态资源，如：
- Images
- CSS
- Static HTML files
- JavaScript files

默认情况下，服务器必须响应每一个传入的请求。但是，一个页面的加载实际上可能意味着四个单独的请求，用于加载上面的资源。当你考虑到使用体积更大的图片时，你的服务器可能会被来自世界各地的用户所淹没。这时，用户需要等待页面的缓慢加载。

![03](./images/01_03.png)

理想情况下，你想通过存储常用的请求响应来减轻服务器的负担。这样你不需要再去处理每一个请求，你可以通过缓存可以立即响应请求。当然，你也可以部署更多的服务器，但是这会需要更多的支出。

### 什么是服务器端缓存
回到我们的农场，知道怎么样可以更容易的运营一家奶牛农场吗？

没错，就是一个有冰箱的超市！

用这种方式，人们不需要去到你的农场，或为了防止牛奶变质马上喝掉。你现在可以用一种安全的方式存放牛奶，甚至几个星期都不会变质。

超市为你的农场分担了很大一部分运营压力，因为你的奶牛不再需要根据顾客的多少实时产出了。超市将会处理这些需求。你只需要确保奶牛日产量达到标准就好。现在，周围的村庄也可以买你农场的牛奶了，因为在超市的冰箱就可以买到。

![04](./images/01_04.png)
![05](./images/01_05.png)

就像超市一样，服务器端的缓存将会处理大量的请求，并且数据的响应也更快、更可靠。

在上图中，我用了 **缓存代理** 这个术语。一个缓存代理是一个服务，它可以存储静态资源文件去响应一些常用请求。一个缓存代理可以拦截常用请求并快速响应，可以防止这些请求对你的主服务增加压力。

你可能有一对问题想问，例如：
1. 一个 "常用" 请求是怎么定义的？
2. 代理的缓存会保存多久？

设置缓存需要一个更长的教程来讲解。现在，你需要知道一个重要的概念——**新鲜度**。
缓存代理将在不同的时间下，缓存不同的文件，并且需要决定是否继续提供这些文件。
这些都取决于你的 **缓存策略**。

它的运行机制和牛奶在超市一摸一样。超市经理需要决定，在扔掉它们之前(变质)，保留你的牛奶到什么时候。缓存代理通过 **缓存命中率** 来衡量是否成功，这部分的内容可以通过缓存代理提供服务。

### 什么是CDN
到现在为止，只有一家超市在卖你的牛奶。虽然这已经是一个很大的进步了，但是你仍然无法为这间超市以外的人提供牛奶(地理限制)。如果你想扩展你的业务，那么你需要加入到更多的店铺中。

所以，假设你把牛奶分布到更多的超市中，那么你可以在一个更大的地理位置满足顾客的需求。这就与内容分发网络很相似，也就是常说的 CDN。CDN 是布满世界各地的代理服务器。

作为一个终端用户，你可能觉得大多数网站加载得非常块是因为网速比较快，其实，是因为它们都使用了 CDN 去派发静态文件。

如果你在英国尝试去加载缓存在弗吉尼亚州服务器的文件，这会有一些延迟，因为原始信号只能在数千英里的电缆上快速传递。一个位于英国本地的缓存代理会更加迅速。

![06](./images/01_06.jpeg)
![07](./images/01_07.png)

### 什么是浏览器缓存
现在，世界各地的人可以把你农场的冷冻牛奶带回家。这里有个问题，他们没有办法在家里存储他们。消费者仍然需要买后尽快喝掉，防止变质，并且需要经常去超市补给。所以，这个机制并不能很好的满足消费者。

解决办法是什么呢？一个冰箱！

有了冰箱后，你可以避免经常去超市买牛奶，在家里就可以存储它们。在缓存机制中，存储静态资源处于一个独立的位置，因为它位于客户端，或者同一台电脑下的浏览器。而我们的代理服务则位于远程的位置。

这对于一些你经常访问的网站非常有利，例如 Facebook 和 Amazon。因为可以减少很多需要处理的请求，从而减少服务器的成本。

![08](./images/01_08.png)
![09](./images/01_09.png)

这里需要注意一点，牛奶不会魔术般自己变到你的冰箱！你还是需要在初次访问的时候请求服务器或代理服务器，然后你就可以在本地缓存这些文件了。

那你的浏览器怎么知道什么时候需要从服务器请求新的文件呢？其实，你永远不会经历这些本地文件的版本更新。

就像牛奶制造商会在牛奶盒子上写一个日期，服务器会在 HTTP 响应头中添加一些标识。HTTP 缓存实际上有四种方式。它们和上面牛奶的"过期日期"方法很像。还有一些方法在获取缓存文件时，仍然需要你的浏览器去服务器确认。

![10](./images/01_10.png)

### 什么时候开始使用缓存
让我们假设你在构建你的第一个 web 应用，在你有上千的用户前，你可能并不需要去担心缓存协议，因为浏览器的成本仍然很低。然而，当你扩大规模时，如果你想让你的应用加载得更快，你就需要应用缓存了。

在浏览器端，当你尝试用新的静态资源去重新加载i 个页面时，你可能会遇到缓存问题了，页面没有发生任何变化。无论你刷新多少次也没有用。

这通常是由于在浏览器端的一些缓存协议导致。如果想跳过你的浏览器缓存，从服务器请求新的资源，你可以在 Mac 中使用 Cmd+Shift+R 或在 PC 中使用 Ctrl+Shift+R 强制刷新页面。